#!/bin/bash
set -e

cd $(dirname $0)/..

function install_brew() {
  if ! type brew &>/dev/null; then
    $(command -v ruby) -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  fi
}

function brew_install_missing_formulas() {
  INSTALLED=$(brew list)

  for formula in $@; do
    grep -q $formula <<<$INSTALLED || brew install $formula
  done
}

function brew_cask_install_missing_formulas() {
  INSTALLED=$(brew cask list)

  for formula in $@; do
    grep -q $formula <<<$INSTALLED || brew cask install $formula
  done
}

set -v

install_brew

brew update

brew upgrade

brew tap \
  heroku/brew \
  homebrew/cask \
  homebrew/core \
  homebrew/services

brew_install_missing_formulas \
  awscli \
  circleci \
  heroku \
  imagemagick \
  postgresql \
  rbenv \
  shfmt \
  terraform \
  yarn

brew_cask_install_missing_formulas \
  chromedriver \
  google-cloud-sdk

brew cleanup

heroku autocomplete --refresh-cache

rbenv install --skip-existing

brew services start postgres

psql postgres --command="SELECT 1 FROM pg_user WHERE usename = 'postgres'" | grep -q 1 || createuser --createdb postgres
