#!/bin/bash
set -e

for bucket in $(s3cmd ls | awk '{print $3}')
do
  echo $bucket
  name=$(echo $bucket | sed 's/s3:\/\///')
  destination=$HOME/Backups/AWS/s3/$name/
  mkdir -p $destination
  s3cmd sync --skip-existing --delete-after $bucket/ $destination
done

for app in $(heroku apps | grep cms | awk '{print $1}')
do
  echo $app
  destination=$HOME/Backups/AWS/$app.dump
  heroku run --app $app 'pg_dump $DATABASE_URL' > $destination
done

echo Backup complete
