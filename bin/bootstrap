#!/bin/bash
set -e

cd `dirname $0`/..

./bin/bundle install

files="
config/secrets.yml
config/deploy/production.secrets.yml
config/deploy/production.rb
config/deploy/staging.secrets.yml
config/deploy/staging.rb
"

for file in $files
do
  if [ ! -f $file ]
  then
    cp ${file}.example $file
  fi
done

rails_secrets="
config/secrets.yml
config/deploy/production.secrets.yml
config/deploy/staging.secrets.yml
"

for file in $rails_secrets
do
  if grep -q '^  secret_key_base:$' $file
  then
    echo "Generating secret for $file"
    secret=`./bin/rake secret`
    echo $secret
    echo "$secret"
    echo "${secret}"
    echo "s/^  secret_key_base:$/  secret_key_base: '${secret}'/"
    echo $file

    sed -i "s/^  secret_key_base:$/  secret_key_base: '${secret}'/" $file
  fi
done

echo "bootstrap complete"
