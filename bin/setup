#!/bin/bash
set -e

cd $(dirname $0)/..

if [ "$(uname)" == "Darwin" ]; then
  ./bin/setup_mac
  . "$NVM_DIR/nvm.sh"
  nvm use
fi

set -v

gem install bundler --version '< 2'
bundle config --local path vendor/bundle
bundle check || bundle install --jobs=3 --retry=3
bundle clean
./bin/yarn

DATABASE_TIMEOUT=5 bin/rails db:create db:migrate db:seed
RAILS_ENV=test DATABASE_TIMEOUT=5 bin/rails db:create

bin/rails log:clear tmp:clear

bin/rails restart

echo "setup complete"
